using System.Linq;
using DBEntity;
using DBEntity.EnumEntity;

namespace Services.Helper.QuotaHelper
{
    public class QuotaHelper
    {
        public static int GetAutoGeneratedQuotaId(int quotaId)
        {
            int autoQuotaId = 0;
            using (var ctx = new SenLan2Entities())
            {
                Quota quota = ctx.Quotas.Include("Contract").FirstOrDefault(o => o.Id == quotaId && o.IsDeleted == false);
                if (quota != null)
                {
                    if ((quota.Contract.TradeType == (int)TradeType.LongForeignTrade || quota.Contract.TradeType == (int)TradeType.ShortForeignTrade))
                    {
                        //外贸（复制）
                        if (quota.RelQuotaId.HasValue)
                        {
                            autoQuotaId = quota.RelQuotaId.Value;
                        }
                    }
                    else if (quota.Contract.TradeType == (int)TradeType.ShortDomesticTrade)
                    { 
                        //内贸短单(流转)
                        if (quota.RelQuotaStage.HasValue)
                        {
                            //如果有RelQuotaStage（只有上家和下家的批次没有）
                            Quota autoQuota = ctx.Quotas.FirstOrDefault(o => o.RelQuotaStage == quota.RelQuotaStage.Value 
                                && o.Id != quota.Id && o.RelQuotaId == quota.RelQuotaId.Value && o.IsDeleted == false);
                            if (autoQuota != null)
                                autoQuotaId = autoQuota.Id;
                        }
                    }
                }
            }
            return autoQuotaId;
        }
    }
}